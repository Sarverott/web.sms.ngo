name: Deploy Production Build via SFTP

on:
    push:
        branches:
            - main

jobs:
    lint-and-build:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: Set up Node.js
            uses: actions/setup-node@v4
            with:
                node-version: '20'

          - name: Install dependencies
            run: npm ci

          - name: Lint and autofix with Biome
            run: npx biome check . --apply

          - name: Run Taskfile tasks (lint, build)
            uses: arduino/setup-task@v1
            with:
                version: 'latest'
          - name: Run lint task
            run: task lint
          - name: Run build task
            run: task build

          - name: Archive production build
            run: tar czf build.tar.gz ./dist

          - name: Deploy to SFTP server
            uses: wangyucode/sftp-upload-action
            with:
                host: ${{ secrets.SFTP_HOST }}
                username: ${{ secrets.SFTP_USER }}
                password: ${{ secrets.SFTP_PASS }}
                port: ${{ secrets.SFTP_PORT }}
                #localDir: build.tar.gz
                #remotDir: /path/on/server/build.tar.gz

          - name: SSH extract build on server
            uses: appleboy/ssh-action@v1.0.3
            with:
                host: ${{ secrets.SFTP_HOST }}
                username: ${{ secrets.SFTP_USER }}
                password: ${{ secrets.SFTP_PASS }}
                port: ${{ secrets.SFTP_PORT }}
                script: |
                    tar xzf /path/on/server/build.tar.gz -C /path/on/server/
                    rm /path/on/server/build.tar.gz